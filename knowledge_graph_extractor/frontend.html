<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ChatBot – Modern Messenger UI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet">

<style>
/* --------------------------------------------------------------
   Design tokens (default = “white” theme)
   -------------------------------------------------------------- */
:root{
    --color-primary:#0084ff;               /* messenger blue            */
    --color-primary-dark:#005c99;
    --color-sent-bg:#dcf8c6;               /* user bubble               */
    --color-received-bg:#ffffff;           /* bot bubble                */
    --color-bg:#f0f2f5;                    /* page background           */
    --color-header-bg:linear-gradient(135deg,#0066ff,#004bb5);
    --color-text:#2c2c2c;
    --color-muted:#777;
    --color-border:#e0e0e0;
    --radius:20px;
    --font-family:'Inter',Arial,Helvetica,sans-serif;
}

/* -----------------------------------------------------------------
   Theme overrides
   ----------------------------------------------------------------- */
.theme-maroon{
    --color-primary:#800020;
    --color-primary-dark:#5a0016;
    --color-sent-bg:#ffe5e5;
    --color-received-bg:#fff5f5;
    --color-bg:#fce7e7;
    --color-header-bg:linear-gradient(135deg,#800020,#5a0016);
    --color-text:#2c2c2c;
    --color-muted:#777;
    --color-border:#e0b0b0;
}
.theme-grey{
    --color-primary:#607d8b;
    --color-primary-dark:#455a64;
    --color-sent-bg:#dbe9f4;
    --color-received-bg:#ffffff;
    --color-bg:#f5f5f5;
    --color-header-bg:linear-gradient(135deg,#607d8b,#455a64);
    --color-text:#212121;
    --color-muted:#666;
    --color-border:#c0c0c0;
}

/* -----------------------------------------------------------------
   Global reset & basic layout
   ----------------------------------------------------------------- */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:var(--font-family);background:var(--color-bg);
        color:var(--color-text);transition:background .3s,color .3s}
.chat-app{
    display:flex;flex-direction:column;width:100%;max-width:480px;height:100vh;
    margin:auto;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.15);
    overflow:hidden;transition:background .3s;
}

/* -----------------------------------------------------------------
   Header (now holds the theme selector)
   ----------------------------------------------------------------- */
.chat-header{
    padding:12px 16px;background:var(--color-header-bg);color:#fff;
    display:flex;align-items:center;gap:12px;transition:background .3s;
}
.chat-header img{width:36px;height:36px;border-radius:50%;object-fit:cover}
.chat-header h2{font-size:1.1rem;font-weight:600;margin:0}

/* Theme selector – right‑aligned */
.theme-switcher{
    margin-left:auto;
}
.theme-switcher select{
    background:transparent;border:none;color:#fff;font-size:0.9rem;
    appearance:none;padding:4px 8px;cursor:pointer;
}

/* -----------------------------------------------------------------
   Conversation body
   ----------------------------------------------------------------- */
.chat-body{
    flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;
}
.chat-body::-webkit-scrollbar{width:6px}
.chat-body::-webkit-scrollbar-thumb{background:#bbb;border-radius:3px}

/* -----------------------------------------------------------------
   Message bubbles
   ----------------------------------------------------------------- */
.message{
    max-width:75%;position:relative;padding:10px 14px;border-radius:var(--radius);
    line-height:1.45;word-break:break-word;animation:fadeIn .2s ease;
    transition:background .2s;
}

/* Sent (user) */
.message.sent{
    align-self:flex-end;background:var(--color-sent-bg);color:#000;
}
.message.sent::after{
    content:"";position:absolute;bottom:0;right:-6px;
    border:6px solid transparent;border-left-color:var(--color-sent-bg);
}

/* Received (bot) – avatar fix */
.message.received{
    align-self:flex-start;background:var(--color-received-bg);color:var(--color-text);
    border:1px solid var(--color-border);margin-left:38px;/* space for avatar */
    position:relative;/* keep pseudo‑tails working */
}
.message.received::before{
    content:"";position:absolute;bottom:0;left:-6px;
    border:6px solid transparent;border-right-color:var(--color-received-bg);
}

/* Avatar – no longer clipping the bubble */
.message.received .avatar{
    width:28px;height:28px;border-radius:50%;overflow:hidden;
    position:absolute;left:-38px;top:0;
}
.message.received .avatar img{width:100%;height:100%;object-fit:cover}

/* Timestamp */
.message .time{
    font-size:0.65rem;color:var(--color-muted);position:absolute;
    bottom:-16px;right:6px;
}

/* -----------------------------------------------------------------
   Typing indicator (three dots)
   ----------------------------------------------------------------- */
.typing-indicator{
    align-self:flex-start;display:flex;gap:4px;padding:8px 14px;
    background:var(--color-received-bg);border:1px solid var(--color-border);
    border-radius:var(--radius);position:relative;
}
.typing-indicator .dot{
    width:6px;height:6px;background:#aaa;border-radius:50%;
    animation:bounce 1s infinite;
}
.typing-indicator .dot:nth-child(2){animation-delay:.2s}
.typing-indicator .dot:nth-child(3){animation-delay:.4s}
@keyframes bounce{
    0%,80%,100%{transform:scale(0.6);opacity:.6}
    40%{transform:scale(1);opacity:1}
}

/* -----------------------------------------------------------------
   Input bar
   ----------------------------------------------------------------- */
.chat-input{
    display:flex;align-items:center;gap:8px;padding:8px;
    border-top:1px solid var(--color-border);background:#fafafa;
}
.chat-input textarea{
    flex:1;resize:none;border:none;outline:none;border-radius:20px;
    padding:10px 14px;font-family:inherit;font-size:1rem;background:#e9ebee;
    max-height:150px;overflow-y:auto;
}
.chat-input button{
    background:var(--color-primary);border:none;width:44px;height:44px;
    border-radius:50%;cursor:pointer;display:flex;align-items:center;
    justify-content:center;color:#fff;transition:background .2s;
}
.chat-input button:disabled{background:#a0c8ff;cursor:not-allowed}
.chat-input button:hover:not(:disabled){background:var(--color-primary-dark)}

/* -----------------------------------------------------------------
   Small utilities / animations
   ----------------------------------------------------------------- */
@keyframes fadeIn{
    from{opacity:0;transform:translateY(6px)}
    to{opacity:1;transform:none}
}

/* -----------------------------------------------------------------
   Responsive tweaks
   ----------------------------------------------------------------- */
@media (max-width:480px){
    .chat-app{border-radius:0;height:100vh}
}
</style>
</head>

<body class="theme-white"><!-- default theme; will be overwritten by JS -->
<div class="chat-app">

    <!-- Header -->
    <header class="chat-header">
        <img src="https://i.pravatar.cc/150?img=68" alt="Bot avatar">
        <h2>ChatBot</h2>

        <!-- Theme switcher -->
        <div class="theme-switcher">
            <select id="theme-select" title="Select theme">
                <option value="white">White</option>
                <option value="maroon">Maroon</option>
                <option value="grey">Grey</option>
            </select>
        </div>
    </header>

    <!-- Conversation -->
    <main class="chat-body" id="chat-body">
        <!-- messages are injected here -->
    </main>

    <!-- Input -->
    <footer class="chat-input">
        <textarea id="msg-input" rows="1" placeholder="Type a message…"></textarea>
        <button id="send-btn" title="Send">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
        </button>
    </footer>
</div>

<script>
/* --------------------------------------------------------------
   Helper functions
   -------------------------------------------------------------- */
function formatTime(date){
    return date.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

/* Create a single message element (type = 'sent' | 'received') */
function createMessage(text, type){
    const msg = document.createElement('div');
    msg.className = `message ${type}`;
    msg.textContent = text;

    // timestamp
    const time = document.createElement('span');
    time.className = 'time';
    time.textContent = formatTime(new Date());
    msg.appendChild(time);

    // Avatar for bot messages
    if(type === 'received'){
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        const img = document.createElement('img');
        img.src = 'https://i.pravatar.cc/150?img=68';
        img.alt = 'Bot';
        avatar.appendChild(img);
        msg.insertBefore(avatar, msg.firstChild);
    }
    return msg;
}

/* Insert into chat body and scroll into view */
function addMessage(text, type){
    const chatBody = document.getElementById('chat-body');
    const el = createMessage(text, type);
    chatBody.appendChild(el);
    el.scrollIntoView({behavior:'smooth', block:'nearest'});
}

/* Typing indicator handling */
function showTyping(){
    const chatBody = document.getElementById('chat-body');
    const indicator = document.createElement('div');
    indicator.className = 'typing-indicator';
    indicator.id = 'typing-indicator';
    for(let i=0;i<3;i++){
        const dot = document.createElement('div');
        dot.className = 'dot';
        indicator.appendChild(dot);
    }
    chatBody.appendChild(indicator);
    indicator.scrollIntoView({behavior:'smooth', block:'nearest'});
}
function hideTyping(){
    const ind = document.getElementById('typing-indicator');
    if(ind) ind.remove();
}

/* --------------------------------------------------------------
   Core logic – sendMessage()
   -------------------------------------------------------------- */
async function sendMessage(){
    const input   = document.getElementById('msg-input');
    const rawText = input.value.trim();
    if(!rawText) return;

    // 1️⃣ Show user bubble instantly
    addMessage(rawText, 'sent');

    // 2️⃣ Reset / collapse the textarea
    input.value = '';
    autoResize();

    // 3️⃣ Show typing animation and lock UI
    showTyping();
    document.getElementById('send-btn').disabled = true;
    input.disabled = true;

    try{
        const response = await fetch('http://127.0.0.1:5011/chat', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({message: rawText})
        });

        if(!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json(); // expects {"response":"…"}
        const botReply = data.response ?? data.reply ?? data.answer ?? '[no reply]';

        hideTyping();
        addMessage(botReply, 'received');
    }catch(err){
        console.error(err);
        hideTyping();
        addMessage('⚠️ Oops! Something went wrong.', 'received');
    }finally{
        // 4️⃣ Unlock UI
        document.getElementById('send-btn').disabled = false;
        input.disabled = false;
        input.focus();
    }
}

/* --------------------------------------------------------------
   UI helpers
   -------------------------------------------------------------- */
function autoResize(){
    const textarea = document.getElementById('msg-input');
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

/* --------------------------------------------------------------
   Theme handling
   -------------------------------------------------------------- */
function setTheme(theme){
    document.body.classList.remove('theme-white','theme-maroon','theme-grey');
    document.body.classList.add('theme-'+theme);
    localStorage.setItem('chatTheme', theme);
}

/* Initialise theme from localStorage (default = white) */
function initTheme(){
    const saved = localStorage.getItem('chatTheme') || 'white';
    const selector = document.getElementById('theme-select');
    selector.value = saved;
    setTheme(saved);
}

/* --------------------------------------------------------------
   Event bindings
   -------------------------------------------------------------- */
document.getElementById('send-btn')
        .addEventListener('click', sendMessage);

document.getElementById('msg-input')
        .addEventListener('input', autoResize);

document.getElementById('msg-input')
        .addEventListener('keydown', e => {
            if(e.key === 'Enter' && !e.shiftKey){
                e.preventDefault();
                sendMessage();
            }
        });

document.getElementById('theme-select')
        .addEventListener('change', e => setTheme(e.target.value));

window.addEventListener('load', () => {
    initTheme();                                 // apply saved theme
    // initial greeting – just for demo
    setTimeout(()=>{
        addMessage('👋 Hi! I’m your friendly chatbot. Ask me anything.', 'received');
    },500);
});
</script>
</body>
</html>